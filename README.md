ingress多重控制场优化模型
==============

-------------

#课题

* 虚拟现实游戏Ingress中, 多重控制场(Control Field)的最优构造方案探索

#队伍组成

* 徐安冉   无36     2013011184  (Enl Agent Lv9 @Allenxu)
* 李思涵   无36     2013011187  (Enl Agent Lv10 @lsh911911)
* 郭一隆   无36     2013011189  (Enl Agent Lv11 @Vone)

#背景介绍

* **Ingress**

    * Ingress是由Google Niantic Labs开发的一款基于GPS定位的大型多人在线的增强现实游戏, 能在Android & iOS平台运行. 


    * Ingress面向全球拥有Google Account的用户免费开发注册, 全球有超过700万的玩家(2014.9).

    * 在国内, 由于访问Google受限, Ingress知名度并不高, 但在各大城市仍有大量忠实玩家.

    * 目前国内ingress玩家出现一轮新人井喷, 清华活跃Ingress玩家由4月份的30人左右增加至40人左右(2015.5).

* **规则介绍**


    * 全球玩家(agent)被划分为两大阵营(Enlightened&Resistence), agent初次进入游戏时自愿选择阵营(Enlightened俗称绿军, Resistence俗称蓝军).

    * 地图上的portal(简称po)为双方争夺的目标, agent可以对portal进行的操作如下表:




# 引论


* **假设1.** 研究的问题中，任意三点（portal）不共线。

* **定义1.** 给定点集，各点位置确定，各点连接关系（直线段相连）不同可形成不同的图。边不交叉的图称为无交叉图。（以下提到的图不加说明均为无交叉图）若无交叉图已为完全图，或满足任加一条边即成为交叉图，则称该无交叉图完全。

* **定义2.** 给定点集，其凸包顶点称为外点，其余点称为内点。

* **定义3.** 无内点的三角形称为原子三角形。

* **定理1.** 定义在同一点集S上的所有无交叉完全图边数均相等。若`S=n`，`S`凸包边界顶点数为`m`，则任意无交叉完全图边数`E=3n-m-3`（加强了参考条目[3]的结论）


* **定义4.** 给定点集`S`，以`S`为顶点集的无交叉图称为`S`的一个划分，其集合记作`Partition(S)`；以`S`为顶点集的有向无交叉图称为`S`上的一个连接方案，其集合记作`Plan(S)`。

* **定义5.** 对于点集`S`的一个完全划分`p`，满足对其任意内点`P0`，均有且仅有3个顶点`P1`,`P2`,`P3`两两相邻且均与P0相邻，且`P0`是三角形`P1P2P3`的内点，则称该划分完美，称`P0`为`P1`,`P2`,`P3`构成的三角形的划分点，该三角形为为P0的外三角形，`P0P1`, `P0P2`, `P0P3`为该三角形的划分边。


* **定义6.** 对于点集S上的一个连接方案，若其边有序，任意顶点出度8，且对于任意边`ei`，任取排在其之前的三条边，则这三条边或不能构成三角形，或`ei`的起始点不在构成的三角形内，则称其为S上的有效连接方案，其集合记作`ValidPlan(S)`。


* **定义7.** （原子多重）对于`p`属于`ValidPlanS`，若`Degree(p)=4`，p中有且只有一个划分点`d`，且`p`的最后一条边为指向`d`的划分边（称其为入射边），p的倒数第二条边与入射边有公共顶点，则称p为原子多重，称d为多重内点。


* **定义8.** （完美连接方案）对于`p`属于`ValidPlan(S)`，若`p`所对应的划分完美，且所有内点均为多重内点，则称`p`为完美连接方案，或称作完美多重。


* **猜想1.** (4-key猜想)对于任意一个给定的点集`S`，存在有效连接方案`p`，使得`p`完美，且其中任一顶点入度4


  **注**：猜想由来：ingress中建立link需要消耗目标portal的key，而hack相应的portal有几率（大约80%）获得当前portal的key，每次hack至多获得一个key，（在不安装加强包的情况下）两次hack之间冷却时间为5min，同一个portal在4小时之内只能被同一个agent hack四次。因此，若一个方案中（尤其是单agent方案）对某些portal的key需求大于4，则需要额外加强包的开销。
  
* **特例1. (4-key猜想的推翻)** 构造如下图所示点集，内点的分布是上凸的。


  这种内点的分布使得虚线上任取三个点，其构成的三角形均为原子三角形。为使p完美，虚线上的每个内点均会使上顶点度增加1，否则划分不完美，如下图。

  而猜想1要求上顶点总度数8+4=12，显然当上凸曲线上的内点数>10时，不存在满足条件的p。



* **定理2.** 对于任意给定正整数`N`，总存在一种点集分布`S`，使得若存在有效完美连接方案，则其中至少有一顶点入度`>N`（即N-key猜想不成立）


  **证明：**同特例1，只需使得上凸曲线上的内点数大于N+6

* **猜想2. (完美多重存在猜想)**对于任意一个给定的点集`S`，必存在有效完美连接方案。

* **引理3.1.** 考虑下图所示的完美划分，则这种完美划分对应的完美连接方案应满足：



* **性质3.1.1** 若AD为△ABC的入射边，则AE为△ABD的入射边。（AD与BD对称，AE与BE对称）

  **证明：**假设AE为出射边。

    对于ABCD构成的完美连接方案，AD为入射边。而AE为出射边，因此AE早于AD之前已连成；连成AD之后不能连DE，因此DE早于AD之前已连成。所以连接AD时，△AED不计算在构成的field中，因此该连接方法不是完美连接方案。

    

* **性质3.1.2** 若DE为△ABD的入射边，则CD为△ABC的入射边。
  **证明：**DE为△ABD的入射边，因此DE的连成晚于AD和BD。所以AD，BD不可能为△ABC的入射边（否则D成为内点，无法射出DE边）。所以CD为△ABC的入射边。












递归算法
=======



## 点的定义

对于点集中的点，用横纵坐标表示。（例如，(10,5)）

## 找出点集的凸包

### 首先把点集按照横坐标值进行排序，并找出横坐标最小的点与横坐标最大的点，这两个点必然在凸包中。

### 寻找下边界

如图所示，当找到顶点Ak时，记其与现在凸包中最近的两点为Ai，Ai-1。则若Ai-1Ak×Ai-1Ai<0，则说明Ak在直线Ai-1Ai左侧，在凸包中添加点Ak；若Ai-1Ak×Ai-1Ai>0，则说明Ak在直线Ai-1Ai右侧，则去除凸包中的点Ai，重新计算Ak，Ai（原Ai-1），Ai-1（原Ai-2）的关系，直到Ak在直线Ai-1Ai左侧或只剩最左侧的顶点，添加上Ak。

### 寻找上边界

与寻找下边界类似，区别在于Ai-1Ak×Ai-1Ai>0时添加Ak。用此方法寻找得到上边界。

## 对凸包进行三角划分

## 找出凸包的完美连接方案

1. 首先对一个三角形，寻找完美连接方案

对于完美划分ABC，定义：
f（A,B,C,Ai,Ao,Bi,Bo,Ci,Co）=m
式子中m表示内部顶点的最大入度，Ai，Ao，Bi，Bo，Ci，Co分别为A,B,C的入度和出度。 
定义dAiAk，当AiAk为Ai入射Ak时，值为1，Ak入射Ai时，值为0。
对于三角形ABC中的其中一个内点D
有递归式：

    f(A,B,C,Ai,Ao,Bi,Bo,Ci,Co,dAB,dBC,dCA)=max{ Ai+dCA+dBA;
                                                Ci+dAC+dBC;
                                                Bi+dCB+dAB;
                                                f(D,B,C,Di1,Do1,Bi1,Bo1,Ci1,Co1,dDB,dBC,dCD);
                                                f(A,D,C,Ai2,Ao2,Di2,Do2,Ci2,Co2,dAD,dDC,dCA);
                                                f(A,B,D,Ai3,Ao3,Bi3,Bo3,Di3,Do3,dAB,dBD,dDA);
                                                Di1+Di2+Di3+dAD+dBD+dCD;
                                                }
    Ai=Ai2+Ai3+dBA+dDA+dCA+init_in[A];
    Ao=Ao2+Ao3+dAB+dAD+dAC+init_out[A];
    Bi=Bi1+Bi3+dBA+dBD+dBC+init_in[B];
    Bo=Bo1+Bo3+dBA+dBD+dBC+init_out[B];
    Ci=Ci1+Ci2+dBC+dDC+dAC+init_in[C];
    Co=Co1+Co2+dCB+dCD+dCA+init_out[C];

在三角形ABC中，对其中每一个顶点，用上式求出m，最终求出最小m的所有解，即为三角形ABC中的所有最佳完美连接方案。



2. 对于凸包，寻找完美连接方案。

对于凸包，将其分为n个三角形，每个三角形包含了其中的内点。
对每个三角形，求出所有的最佳完美连接方案。对这些最佳完美连接方案，以“两个三角形相接的边方向必须相同，以及顶点已有的出度”作为约束条件，求出凸包划分中之后一个三角形的所有最佳完美连接方案，直到划分中的所有三角形完成第一步中的递归算法。
这样就组合出所有的完美连接方案。（这些完美连接方案已经包含了所有顶点）

**注：**对于两个三角形相接的边方向相同用参数dAiAk来表示，顶点已有出度用init_out表示。

则完美连接方案的最大key需求量：

    M=max{  fi(Ai,Aj,Ak,Aii,Aio,Aji,Ajo,Aki,Ako),
            Apin,
            }

**注：**Ai,Aj,Ak为凸包进行划分后划分三角形的三个顶点；Ap为凸包中的顶点

    Apin=ΣApii-ΣdBkAp

**注：**等式前一项为所有包含Ap的三角形中的Api之和，后一项中dBkAp为包含Ap的三角形，包含Ap的边是否入射Ap

这样求出所有可行的完美连接方案，得到最优解。

##算法的弊端及优化

上述算法能够得到理论上的最优解，但其弊端也十分明显，就是时间复杂度极高。程序的运行时间呈指数爆炸式增长，在内点增加到一定程度之后就难以得到结果。因此，必须对以上算法进行一定的优化，在能够满足大部分需求，并能够在大部分情况下得到最优解的条件下大大减少时间复杂度。

### 实现方法
   
   算法优化采用map检索系统，即在原有的递归算法下，加入算过顶点的map，当计算到f(A,B,C,Ai,Bi,Ci)时，若之前已计算过三角形ABC的最优连接方式，则使用之前已计算的连接方式。

代码实现：




# 测试结果及分析

我们对写出的算法程序进行了测试，测试样例为雕塑园各portal实际位置。
我们对现有的算法以及我们的算法进行了比较，可得如下表格：


从表格可以看出，我们的算法能够一次性算出较好的连接方案，而使用随机算法则需要测试大量次数才能得到较好的连接方案，而采用“肩搭肩”的策略得到的连接方案最大key的数量较大，并不是十分好的连接方案，其优点在于agent行动路程较短。
对于agent的行动路程，我们的算法在设计中并没有考虑该因素，对于单个agent行动的方案来说，其行走距离与随机算法得到的方案差别不大，而“肩搭肩”策略得到的连接方案行动路程短。而对于多个agent来说，行走距离大大减少，“肩搭肩”策略在这种情况下完全失去了优越性。
